name: Generate Images

on:
    push:
        branches: ['main', 'master']
        paths:
            - 'content/components/**'
            - 'resources/views/**'
    workflow_dispatch:

permissions:
    contents: write

jobs:
    generate-images:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ github.head_ref }}

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.2'
                  extensions: mbstring, intl, pdo, sqlite, pdo_sqlite, gd

            - name: Copy .env
              run: php -r "file_exists('.env') || copy('.env.example', '.env');"

            - name: Install Composer Dependencies
              run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

            - name: Generate Key
              run: php artisan key:generate

            - name: Directory Permissions
              run: chmod -R 777 storage bootstrap/cache

            - name: Install NPM & Build
              run: |
                  npm ci
                  npm run build

            - name: Install Puppeteer
              run: npm install puppeteer

            - name: Serve Application
              run: php artisan serve --port=8000 &
              env:
                  APP_URL: http://127.0.0.1:8000

            - name: Wait for Server
              run: sleep 10

            - name: Generate Images
              run: php artisan og:generate
              env:
                  APP_URL: http://127.0.0.1:8000

            - name: Commit changes
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                  commit_message: 'chore: update og images [skip ci]'
                  file_pattern: 'public/og-images/*.png public/thumbnails/*.png content/components/*.md'
